import pandas as pd        ğŸ§ 
import pendulum            ğŸ§ 
from snowflake.connector import connect     ğŸ“˜
from snowflake.connector.pandas_tools import write_pandas   ğŸ“˜
from src.config import SNOWFLAKE           ğŸ§ 
import os                                  ğŸ§ 

class SnowflakeClient:                     ğŸ§ 
    """Handles connection, table setup, data writes, and checkpoints in Snowflake."""

    def __init__(self):                    ğŸ§ 
        """Initialize connection, cursor, and ensure required Snowflake objects exist."""
        self.conn = self._connect()        ğŸ§ 
        self.cursor = self.conn.cursor()   ğŸ§ 
        self._ensure_objects_exist()       ğŸ§ 

def _connect(self):                                         ğŸ§ 
    """Establish a secure RSA-based connection to Snowflake."""
    private_key_path = SNOWFLAKE.get("private_key_path")    ğŸ§ 

    if private_key_path and os.path.exists(private_key_path):   ğŸ§ 
        import snowflake.connector                             ğŸ“˜
        import cryptography.hazmat.primitives.serialization as serialization   ğŸ“˜
        from cryptography.hazmat.backends import default_backend                ğŸ“˜

        with open(private_key_path, "rb") as key:              ğŸ§ 
            p_key = serialization.load_pem_private_key(        ğŸ“˜
                key.read(), password=None, backend=default_backend()
            )
        pkb = p_key.private_bytes(                             ğŸ“˜
            encoding=serialization.Encoding.DER,
            format=serialization.PrivateFormat.PKCS8,
            encryption_algorithm=serialization.NoEncryption(),
        )
        conn = connect(                                        ğŸ§ 
            account=SNOWFLAKE["account"],
            user=SNOWFLAKE["user"],
            role=SNOWFLAKE["role"],
            warehouse=SNOWFLAKE["warehouse"],
            database=SNOWFLAKE["database"],
            schema=SNOWFLAKE["schema"],
            private_key=pkb,                                   ğŸ“˜
        )
    else:
        raise FileNotFoundError(f"Private key not found: {private_key_path}")  ğŸ§ 

    print("âœ… Connected to Snowflake successfully.")            ğŸ§ 
    return conn                                                ğŸ§ 

def _ensure_objects_exist(self):                               ğŸ§ 
    """Ensure database tables exist: RAW.DAILY_STOCKS and ADMIN.INGESTION_CHECKPOINTS."""
    print("Checking or creating necessary tables...")           ğŸ§ 

    self.cursor.execute("""CREATE SCHEMA IF NOT EXISTS RAW;""") ğŸ§ 
    self.cursor.execute("""CREATE SCHEMA IF NOT EXISTS ADMIN;""")ğŸ§ 

    # Table for stock data
    self.cursor.execute("""                                    ğŸ“˜
        CREATE TABLE IF NOT EXISTS RAW.DAILY_STOCKS (
            T STRING,
            V FLOAT,
            VW FLOAT,
            O FLOAT,
            C FLOAT,
            H FLOAT,
            L FLOAT,
            N INT,
            DATE DATE,
            INGESTED_AT TIMESTAMP_NTZ
        );
    """)

    # Table for checkpoints
    self.cursor.execute("""                                    ğŸ“˜
        CREATE TABLE IF NOT EXISTS ADMIN.INGESTION_CHECKPOINTS (
            RUN_ID STRING,
            API_DATE DATE,
            STATUS STRING,
            TOTAL_TICKERS INT,
            ROWS_INSERTED INT,
            STARTED_AT TIMESTAMP_NTZ,
            COMPLETED_AT TIMESTAMP_NTZ,
            ERROR_MESSAGE STRING
        );
    """)
    self.conn.commit()                                          ğŸ§ 
    print("âœ… Verified table existence.")                       ğŸ§ 

def write_dataframe(self, df: pd.DataFrame, table_name: str):   ğŸ§ 
    """Write a pandas DataFrame into Snowflake using write_pandas()."""
    if df is None or df.empty:                                  ğŸ§ 
        print("âš ï¸ DataFrame is empty; skipping load.")
        return False, 0

    success, nchunks, nrows, _ = write_pandas(                  ğŸ“˜
        conn=self.conn,
        df=df,
        table_name=table_name,
        database=SNOWFLAKE["database"],
        schema=SNOWFLAKE["schema"],
        quote_identifiers=False
    )

    if success:                                                 ğŸ§ 
        print(f"âœ… Successfully loaded {nrows} rows into {table_name}.")
        return True, nrows
    else:
        print(f"âŒ Failed to load data into {table_name}.")
        return False, 0

def record_checkpoint(self, run_id, api_date, status, total_tickers=None,
                      rows_inserted=None, error_message=None):   ğŸ§ 
    """Insert a checkpoint record into ADMIN.INGESTION_CHECKPOINTS."""
    now = pendulum.now()                                        ğŸ§ 
    started_at = now if status == "started" else None           ğŸ§ 
    completed_at = now if status in ["completed", "failed"] else None  ğŸ§ 

    query = f"""                                                ğŸ“˜
        INSERT INTO ADMIN.INGESTION_CHECKPOINTS (
            RUN_ID, API_DATE, STATUS, TOTAL_TICKERS,
            ROWS_INSERTED, STARTED_AT, COMPLETED_AT, ERROR_MESSAGE
        ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
    """
    self.cursor.execute(query, (                                ğŸ§ 
        run_id, api_date, status, total_tickers,
        rows_inserted, started_at, completed_at, error_message
    ))
    self.conn.commit()                                          ğŸ§ 
    print(f"ğŸªµ Checkpoint recorded for {api_date} â€” {status}")   ğŸ§ 


def get_completed_dates(self):                                  ğŸ§ 
    """Return all API_DATE values where status='completed'."""
    query = """                                                 ğŸ“˜
        SELECT DISTINCT API_DATE
        FROM ADMIN.INGESTION_CHECKPOINTS
        WHERE STATUS = 'completed'
    """
    try:
        self.cursor.execute(query)                              ğŸ§ 
        dates = {row[0].strftime("%Y-%m-%d") for row in self.cursor.fetchall()}  ğŸ§ 
        print(f"Found {len(dates)} completed dates.")           ğŸ§ 
        return dates                                            ğŸ§ 
    except Exception as e:
        print(f"Error reading checkpoint table: {e}")           ğŸ§ 
        return set()

def close(self):                                                ğŸ§ 
    """Close Snowflake connection."""
    try:
        self.cursor.close()                                     ğŸ§ 
        self.conn.close()                                       ğŸ§ 
        print("ğŸ”’ Connection closed.")                          ğŸ§ 
    except Exception:
        pass

